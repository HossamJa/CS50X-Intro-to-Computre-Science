<!DOCTYPE html>

<html lang="en">
    <head>
        <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500&display=swap" rel="stylesheet">
        <link href="/static/styles.css" rel="stylesheet">
        <title>Birthdays</title>
    </head>
    <body>
        <div class="header">
            <h1>Birthdays</h1>
        </div>
        <div class="container">
            <div class="section">

                <h2>Add a Birthday</h2>
                <!-- Create a form for users to submit a name, a month, and a day -->
                <form action="/" method="post">
                    <input name="name" placeholder="Name" type="text" required>
                    <input name="bdate" type="date" required>
                    <input type="submit" value="Add Birthday">
                </form>
            </div>

            <div class="section">

                <h2>All Birthdays</h2>
                <table>
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Birthday</th>
                            <th id="edit-header"></th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for bday in birthdays %}
                            <tr data-row-id="{{ bday.id }}">
                                <td class="editable-cell text-cell">{{bday.name}}</td>
                                <!-- Ensure the full YYYY-MM-DD format is rendered as inner text for the JS date picker -->
                                <td class="editable-cell date-cell">{{bday.year}}-{{'%02d'|format(bday.month)}}-{{'%02d'|format(bday.day)}}</td>
                                <td class="action-cell">
                                    <button onclick="editRow(this)">Edit</button>
                                    <button onclick="deleteRow(this)">Delete</button>
                                </td>
                            </tr>
                        {%endfor%}
                    </tbody>
                </table>
                <script>
                    // --- Edit Row Function (Handles UI changes and DB saving) ---
                    async function editRow(button) {
                        const row = button.parentNode.parentNode;
                        const cells = row.querySelectorAll('.editable-cell');
                        const isEditing = button.innerText === "Save";

                        if (isEditing) {
                            // --- SAVE LOGIC ---
                            const rowId = row.getAttribute('data-row-id');
                            // Ensure we select input from within the correct cell index
                            const nameInput = cells[0].querySelector('input');
                            const dateInput = cells[1].querySelector('input');

                            const updatedData = {
                                name: nameInput.value,
                                birthday: dateInput.value // YYYY-MM-DD format sent to Flask
                            };
                            
                            // Revert UI to text before the fetch completes 
                            cells[0].innerHTML = nameInput.value;
                            cells[1].innerHTML = dateInput.value.split('-');

                            // Send Data to Flask API
                            try {
                                const response = await fetch(`/update/${rowId}`, {
                                    method: 'PUT', // Matches Flask route method='PUT'
                                    headers: {
                                        'Content-Type': 'application/json',
                                    },
                                    body: JSON.stringify(updatedData),
                                });

                                if (!response.ok) {
                                    throw new Error('Server response not OK');
                                }

                                const result = await response.json();
                                if (result.status === 'success') {
                                    button.innerText = "Edit";
                                }

                            } catch (error) {
                                console.error('Fetch error:', error);
                                alert("Failed to connect to server or save data.");
                            }

                        } else {
                            // --- EDIT MODE (Handles Text -> Input conversion) ---
                            const currentName = cells[0].innerText;
                            // currentBday is 'YYYY-MM-DD' from the initial render
                            const currentBday = cells[1].innerText; 
                            
                            cells[0].innerHTML = `<input type="text" value="${currentName}">`;
                            cells[1].innerHTML = `<input type="date" value="${currentBday}">`;
                            button.innerText = "Save";
                        }
                    }

                    // --- Delete Row Function (Handles AJAX deletion) ---
                    async function deleteRow(button) {
                        const row = button.parentNode.parentNode;
                        const rowId = row.getAttribute('data-row-id');

                        if (confirm(`Are you sure you want to delete this birthday?`)) {
                            try {
                                const response = await fetch(`/update/${rowId}`, {
                                    method: 'POST',
                                });

                                if (!response.ok) {
                                    throw new Error('Server response not OK');
                                }

                                const result = await response.json();
                                if (result.status === 'success') {
                                    row.remove(); // Remove the row from the UI
                                } else {
                                    alert("Error deleting: " + result.message);
                                }

                            } catch (error) {
                                console.error('Fetch error:', error);
                                alert("Failed to delete row.");
                            }
                        }
                    }
                </script>
            </div>
        </div>
    </body>
</html>
